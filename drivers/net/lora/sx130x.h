/* SPDX-License-Identifier: GPL-2.0-or-later */
/*
 * Semtech SX1301 LoRa concentrator
 *
 * Copyright (c) 2018 Ben Whitten
 * Copyright (c) 2018 Andreas FÃ¤rber
 */

#ifndef _SX130X_
#define _SX130X_

#include <linux/regmap.h>

#define SX1301_CHIP_VERSION 103

#define SX1301_MCU_FW_BYTE 8192
#define SX1301_MCU_ARB_FW_VERSION 1
#define SX1301_MCU_AGC_FW_VERSION 4
#define SX1301_MCU_AGC_CAL_FW_VERSION 2

#define SX1301_AGC_CMD_WAIT 16
#define SX1301_AGC_CMD_ABORT 17

#define SX1301_AGC_STATUS_READY 0x10
#define SX1301_AGC_STATUS_SUCCESS 0x30
#define SX1301_AGC_STATUS_INITIALISED 0x40

#define SX1301_TX_GAIN_LUT_MAX 16
#define SX1301_PA_GAIN_OFFSET 6
#define SX1301_DAC_GAIN_OFFSET 4

#define SX1301_NUM_GPIOS 5

/* Calibrated value for 500KHz BW and notch filter disabled */
#define TX_START_DELAY_DEFAULT  1497
#define IF_HZ_TO_REG(f)     (f << 5)/15625

/* Page independent */
#define SX1301_PAGE     0x00
#define SX1301_VER      0x01
#define SX1301_RX_DATA_BUF_ADDR 0x02 /* 16 wide */
#define SX1301_RX_DATA_BUF_DATA 0x04
#define SX1301_TX_DATA_BUF_ADDR 0x05
#define SX1301_TX_DATA_BUF_DATA 0x06
#define SX1301_MPA      0x09
#define SX1301_MPD      0x0A
#define SX1301_RPNS     0x0B
#define SX1301_RPAPL    0x0C
#define SX1301_RPAPH    0x0D
#define SX1301_RPS      0x0E
#define SX1301_RPPS     0x0F
#define SX1301_GEN      0x10
#define SX1301_CKEN     0x11
#define SX1301_GPSO     0x1C
#define SX1301_GPMODE   0x1D
#define SX1301_AGCSTS   0x20

#define SX1301_VIRT_BASE    0x100
#define SX1301_PAGE_LEN     0x80
#define SX1301_PAGE_BASE(n) (SX1301_VIRT_BASE + (SX1301_PAGE_LEN * n))

/* Page 0 */
#define SX1301_IQCFG        (SX1301_PAGE_BASE(0) + 0x21)
#define SX1301_CHRS         (SX1301_PAGE_BASE(0) + 0x23)
#define SX1301_IF0L         (SX1301_PAGE_BASE(0) + 0x24)
#define SX1301_IF0H         (SX1301_PAGE_BASE(0) + 0x25)
#define SX1301_IF1L         (SX1301_PAGE_BASE(0) + 0x26)
#define SX1301_IF1H         (SX1301_PAGE_BASE(0) + 0x27)
#define SX1301_IF2L         (SX1301_PAGE_BASE(0) + 0x28)
#define SX1301_IF2H         (SX1301_PAGE_BASE(0) + 0x29)
#define SX1301_IF3L         (SX1301_PAGE_BASE(0) + 0x2A)
#define SX1301_IF3H         (SX1301_PAGE_BASE(0) + 0x2B)
#define SX1301_IF4L         (SX1301_PAGE_BASE(0) + 0x2C)
#define SX1301_IF4H         (SX1301_PAGE_BASE(0) + 0x2D)
#define SX1301_IF5L         (SX1301_PAGE_BASE(0) + 0x2E)
#define SX1301_IF5H         (SX1301_PAGE_BASE(0) + 0x2F)
#define SX1301_IF6L         (SX1301_PAGE_BASE(0) + 0x30)
#define SX1301_IF6H         (SX1301_PAGE_BASE(0) + 0x31)
#define SX1301_IF7L         (SX1301_PAGE_BASE(0) + 0x32)
#define SX1301_IF7H         (SX1301_PAGE_BASE(0) + 0x33)
#define SX1301_IF8L         (SX1301_PAGE_BASE(0) + 0x34)
#define SX1301_IF8H         (SX1301_PAGE_BASE(0) + 0x35)
#define SX1301_IF9L         (SX1301_PAGE_BASE(0) + 0x36)
#define SX1301_IF9H         (SX1301_PAGE_BASE(0) + 0x37)
#define SX1301_COR0DETEN    (SX1301_PAGE_BASE(0) + 0x41)
#define SX1301_COR1DETEN    (SX1301_PAGE_BASE(0) + 0x42)
#define SX1301_COR2DETEN    (SX1301_PAGE_BASE(0) + 0x43)
#define SX1301_COR3DETEN    (SX1301_PAGE_BASE(0) + 0x44)
#define SX1301_COR4DETEN    (SX1301_PAGE_BASE(0) + 0x45)
#define SX1301_COR5DETEN    (SX1301_PAGE_BASE(0) + 0x46)
#define SX1301_COR6DETEN    (SX1301_PAGE_BASE(0) + 0x47)
#define SX1301_COR7DETEN    (SX1301_PAGE_BASE(0) + 0x48)
#define SX1301_CORR_CFG     (SX1301_PAGE_BASE(0) + 0x4E)
#define SX1301_MODEM_START_RDX4L (SX1301_PAGE_BASE(0) + 0x51)
#define SX1301_MODEM_START_RDX4H (SX1301_PAGE_BASE(0) + 0x52)
#define SX1301_MODEM_START_SF12_RDX4L (SX1301_PAGE_BASE(0) + 0x53)
#define SX1301_MODEM_START_SF12_RDX4H (SX1301_PAGE_BASE(0) + 0x54)
#define SX1301_FREQ_TO_TIME_DRIFT (SX1301_PAGE_BASE(0) + 0x5D)
#define SX1301_FRAME_SYNCH  (SX1301_PAGE_BASE(0) + 0x5F)
#define SX1301_MISC_CFG1    (SX1301_PAGE_BASE(0) + 0x63)
#define SX1301_MISC_CFG2    (SX1301_PAGE_BASE(0) + 0x64)
#define SX1301_GAIN_OFFSET  (SX1301_PAGE_BASE(0) + 0x68)
#define SX1301_FORCE_CTRL   (SX1301_PAGE_BASE(0) + 0x69)
#define SX1301_MCU_CTRL     (SX1301_PAGE_BASE(0) + 0x6A)
#define SX1301_RSSI_BB_DEFAULT_VALUE 	(SX1301_PAGE_BASE(0) + 0x6C)
#define SX1301_RSSI_DEC_DEFAULT_VALUE 	(SX1301_PAGE_BASE(0) + 0x6D)
#define SX1301_RSSI_CHANN_DEFAULT_VALUE (SX1301_PAGE_BASE(0) + 0x6E)
#define SX1301_RSSI_BB_FILTER_ALPHA 	(SX1301_PAGE_BASE(0) + 0x6F)
#define SX1301_RSSI_DEC_FILTER_ALPHA 	(SX1301_PAGE_BASE(0) + 0x70)
#define SX1301_RSSI_CHANN_FILTER_ALPHA 	(SX1301_PAGE_BASE(0) + 0x71)
#define SX1301_IQ_MISMATCH_A_AMP_COEFF 	(SX1301_PAGE_BASE(0) + 0x72)
#define SX1301_IQ_MISMATCH_A_PHI_COEFF 	(SX1301_PAGE_BASE(0) + 0x73)
#define SX1301_IQ_MISMATCH_B_AMP_COEFF 	(SX1301_PAGE_BASE(0) + 0x74)
#define SX1301_IQ_MISMATCH_B_PHI_COEFF 	(SX1301_PAGE_BASE(0) + 0x75)

/* Page 1 */
#define SX1301_TX_TRIG      (SX1301_PAGE_BASE(1) + 0x21)
#define SX1301_TX_START_DELAYL      (SX1301_PAGE_BASE(1) + 0x22)
#define SX1301_TX_START_DELAYH      (SX1301_PAGE_BASE(1) + 0x23)
#define SX1301_TX_FRAME_SYNCH       (SX1301_PAGE_BASE(1) + 0x24)
#define SX1301_TX_OFFSET_I          (SX1301_PAGE_BASE(1) + 0x27)
#define SX1301_TX_OFFSET_Q          (SX1301_PAGE_BASE(1) + 0x28)
#define SX1301_TX_CFG2              (SX1301_PAGE_BASE(1) + 0x2A)
#define SX1301_BHSYNCPOS            (SX1301_PAGE_BASE(1) + 0x2E)
#define SX1301_MBWSSF_FREQ_TO_TIME_DRIFT (SX1301_PAGE_BASE(1) + 0x35)
#define SX1301_MBWSSF_MISC_CFG2     (SX1301_PAGE_BASE(1) + 0x3B)
#define SX1301_FSK_CFG1             (SX1301_PAGE_BASE(1) + 0x3F)
#define SX1301_FSK_CFG2             (SX1301_PAGE_BASE(1) + 0x40)
#define SX1301_FSK_ERROR_OSR_TOL    (SX1301_PAGE_BASE(1) + 0x41)
#define SX1301_FSK_REF_PATTERN_LSB  (SX1301_PAGE_BASE(1) + 0x44)
#define SX1301_FSK_REF_PATTERN_MSB  (SX1301_PAGE_BASE(1) + 0x48)
#define SX1301_FSK_PKT_LENGTH       (SX1301_PAGE_BASE(1) + 0x4C)
#define SX1301_FSK_TX               (SX1301_PAGE_BASE(1) + 0x4D)
#define SX1301_FSK_PATTERN_TIMEOUT_CFGL (SX1301_PAGE_BASE(1) + 0x53)
#define SX1301_FSK_PATTERN_TIMEOUT_CFGH (SX1301_PAGE_BASE(1) + 0x54)

/* Page 2 */
#define SX1301_RADIO_A_SPI_DATA     (SX1301_PAGE_BASE(2) + 0x21)
#define SX1301_RADIO_A_SPI_DATA_RB  (SX1301_PAGE_BASE(2) + 0x22)
#define SX1301_RADIO_A_SPI_ADDR     (SX1301_PAGE_BASE(2) + 0x23)
#define SX1301_RADIO_A_SPI_CS       (SX1301_PAGE_BASE(2) + 0x25)
#define SX1301_RADIO_B_SPI_DATA     (SX1301_PAGE_BASE(2) + 0x26)
#define SX1301_RADIO_B_SPI_DATA_RB  (SX1301_PAGE_BASE(2) + 0x27)
#define SX1301_RADIO_B_SPI_ADDR     (SX1301_PAGE_BASE(2) + 0x28)
#define SX1301_RADIO_B_SPI_CS       (SX1301_PAGE_BASE(2) + 0x2A)
#define SX1301_RADIO_CFG            (SX1301_PAGE_BASE(2) + 0x2B)
#define SX1301_DBG_ARB_MCU_RAM_DATA (SX1301_PAGE_BASE(2) + 0x40)
#define SX1301_DBG_AGC_MCU_RAM_DATA (SX1301_PAGE_BASE(2) + 0x41)
#define SX1301_DBG_ARB_MCU_RAM_ADDR (SX1301_PAGE_BASE(2) + 0x50)
#define SX1301_DBG_AGC_MCU_RAM_ADDR (SX1301_PAGE_BASE(2) + 0x51)
#define SX1301_GPS		    (SX1301_PAGE_BASE(2) + 0x59)

/* Page 3 */
#define SX1301_EMERGENCY_FORCE_HOST_CTRL (SX1301_PAGE_BASE(3) + 0x7F)

#define SX1301_MAX_REGISTER         (SX1301_PAGE_BASE(3) + 0x7F)

enum sx130x_fields {
	F_SOFT_RESET,
	F_MBWSSF_MODEM_EN,
	F_CON_MODEM_EN,
	F_FSK_MODEM_EN,
	F_GLOBAL_EN,
	F_CLK32M_EN,
	F_RADIO_A_EN,
	F_RADIO_B_EN,
	F_RADIO_RST,

	F_MCU_RST_0,
	F_MCU_RST_1,
	F_MCU_SELECT_MUX_0,
	F_MCU_SELECT_MUX_1,

	F_FORCE_HOST_RADIO_CTRL,
	F_FORCE_HOST_FE_CTRL,
	F_FORCE_DEC_FILTER_GAIN,

	F_EMERGENCY_FORCE_HOST_CTRL,

	F_TX_TRIG_IMMEDIATE,
	F_TX_TRIG_DELAYED,
	F_TX_TRIG_GPS,

	F_RSSI_BB_FILTER_ALPHA,
	F_RSSI_DEC_FILTER_ALPHA,
	F_RSSI_CHANN_FILTER_ALPHA,

	F_RSSI_BB_DEFAULT_VALUE,
	F_RSSI_DEC_DEFAULT_VALUE,
	F_RSSI_CHANN_DEFAULT_VALUE,

	F_DEC_GAIN_OFFSET,
	F_CHAN_GAIN_OFFSET,

	F_SNR_AVG_CST,
	F_FRAME_SYNCH_PEAK1_POS,
	F_FRAME_SYNCH_PEAK2_POS,

	F_MBWSSF_FRAME_SYNCH_PEAK1_POS,
	F_MBWSSF_FRAME_SYNCH_PEAK2_POS,

	F_ADJUST_MODEM_START_OFFSET_RDX4L,
	F_ADJUST_MODEM_START_OFFSET_RDX4H,
	F_ADJUST_MODEM_START_OFFSET_SF12_RDX4L,
	F_ADJUST_MODEM_START_OFFSET_SF12_RDX4H,
	F_CORR_MAC_GAIN,

	F_FSK_RX_INVERT,
	F_FSK_MODEM_INVERT_IQ,
	F_MODEM_INVERT_IQ,

	F_FSK_RSSI_LENGTH,
	F_FSK_PKT_MODE,
	F_FSK_PSIZE,
	F_FSK_CRC_EN,
	F_FSK_DCFREE_ENC,
	F_FSK_ERROR_OSR_TOL,
	F_FSK_PKT_LENGTH,
	F_FSK_PATTERN_TIMEOUT_CFGL,
	F_FSK_PATTERN_TIMEOUT_CFGH,

	F_TX_START_DELAYL,
	F_TX_START_DELAYH,

	F_TX_GAIN,
	F_TX_SWAP_IQ,
	F_TX_FRAME_SYNCH_PEAK1_POS,
	F_TX_FRAME_SYNCH_PEAK2_POS,

	F_FSK_TX_GAUSSIAN_SELECT_BT,
	F_FSK_TX_PSIZE,

	F_GPS_EN,
};

struct regmap *sx130x_get_regmap(struct device *dev);
void sx130x_io_lock(struct device *dev);
void sx130x_io_unlock(struct device *dev);

int __init sx130x_radio_init(void);
void __exit sx130x_radio_exit(void);
int sx130x_register_radio_devices(struct device *dev);
int devm_sx130x_register_radio_devices(struct device *dev);
void sx130x_unregister_radio_devices(struct device *dev);
bool sx130x_radio_devices_okay(struct device *dev);

#endif
